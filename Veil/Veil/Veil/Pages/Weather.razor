@page "/weather"
@using Microsoft.EntityFrameworkCore
@using Newtonsoft.Json
@using ThirdPartyApis
@using Veil.Data.Weather
@inject IJSRuntime JS
@inject GlobalStateService gss
@inject ISnackbar Snackbar
@inject IDbContextFactory<VeilContext> dbFactory

<PageTitle>Veil | Weather</PageTitle>




@if (gss.IsTransmissionEnabled) {

        @if (weatherService != null && weatherService.ForecastResult != null)
        {
        <WeatherChart             
            YAxisLabel="Weather at Current Location"
            XAxisLabel="Time (HH)"
            SeriesElement1Label="@TempuratureChartLabel"
            SeriesElement1="weatherService.ForecastResult.hourly.temperature_2m.Cast<object>().ToList()"

            SeriesElement2Label="Apparent Tempurature"
            SeriesElement2="weatherService.ForecastResult.hourly.apparent_temperature.Cast<object>().ToList()"
            
            SeriesElement3Label="Precipation"
            SeriesElement3="weatherService.ForecastResult.hourly.precipitation.Cast<object>().ToList()"
        ></WeatherChart>
        }

}

        <MudGrid>
    <MudItem xs="6">
        <MudPaper Height="45vh" Class="d-flex align-center justify-center mud-width-full py-8">
            @if (showMap)
            {
            <Map RequestedLatitude="10.0" RequestedLongitude="15.0"  HeightPercentage="110"/> 
            } else {
                <MudButton OnClick="ToggleMap" Color="Color.Primary" Variant="Variant.Filled">Show Weather Location</MudButton>
            }
        </MudPaper>
    </MudItem>

    <MudItem xs="6">
        <MudPaper Class="d-flex align-center justify-center mud-width-full py-8">xs=6</MudPaper>
    </MudItem>
</MudGrid>


@code {
    public double Latitude { get; set; }
    public double Longitude { get; set; }
    public WeatherService weatherService { get; set; }
    public bool showMap { get; set; } = false;

    public string TempuratureChartLabel { get; set; } = String.Empty;



    protected override async Task OnParametersSetAsync()
    {
        if(gss.IsTransmissionEnabled) 
            await InitializeWeatherChart();
        else 
            Snackbar.Add("Transmission is disabled. Please re-enable to retreive updated weather stats. Now displaying most recent weather for your location, retreieved at TODO time.", Severity.Error);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {

        if(!firstRender) {
            if(gss.IsTransmissionEnabled)
            {
                await InitializeWeatherChart();
            }
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    public void ToggleMap()
    {
            showMap = !showMap;
    }

    // TODO make this work for multiple charts
    public async Task InitializeWeatherChart() 
    {
            var ctx = dbFactory.CreateDbContext();
            Latitude = await Util.Geolocation.GetLatitude(JS);
            Longitude = await Util.Geolocation.GetLongitude(JS);
            weatherService = new WeatherService(ctx, Latitude, Longitude);
            await weatherService.GetTodaysWeatherAsync();

            TempuratureChartLabel = $"Tempurature °C ({Latitude}, {Longitude})";

            await weatherService.SaveLatestWeatherAsync();
            weatherService.SaveLatestWeather();

            var mostRecentForecast = GetMostRecentForecast(ctx);


    }

    public ForecastResult GetMostRecentForecast(VeilContext ctx)
    {

            var mostRecentForecast = ctx.WeatherForecasts.OrderByDescending(x => x.dt_retreived).First();

            return mostRecentForecast;
    }
}

